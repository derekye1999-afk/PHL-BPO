<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²å¾‹å®¾BPOé¡¹ç›®æ€»æ§ä»ªè¡¨ç›˜</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Apple Style Color Palette */
            --bg-body: #F5F5F7;           /* ç»å…¸ Apple æµ…ç°èƒŒæ™¯ */
            --bg-card: #FFFFFF;           /* çº¯ç™½å¡ç‰‡ */
            
            /* æ–‡å­—é¢œè‰² */
            --text-primary: #1D1D1F;      /* è¿‘ä¹é»‘çš„æ·±ç° */
            --text-secondary: #86868B;    /* è¾…åŠ©è¯´æ˜ç° */
            --text-tertiary: #BFBFBF;     /* å ä½ç¬¦ç° */
            
            /* å“ç‰Œè‰² */
            --accent-blue: #0071e3;       /* Apple Blue */
            --accent-blue-hover: #0077ED;
            
            /* æ¨¡å—åŠŸèƒ½è‰² (æ›´åŠ æŸ”å’Œçš„è°ƒè‰²) */
            --color-order: #0071e3;       /* è“ */
            --color-order-bg: #e8f2ff;
            --color-drawing: #ff9f0a;     /* æ©™ */
            --color-drawing-bg: #fff5e5;
            --color-delivery: #34c759;    /* ç»¿ */
            --color-delivery-bg: #eafbf0;
            --color-ncr: #ff3b30;         /* çº¢ */
            --color-ncr-bg: #ffeceb;

            /* é˜´å½±ç³»ç»Ÿ (å¼¥æ•£ã€æŸ”å’Œ) */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.06);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.08);
            
            /* åœ†è§’ */
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            
            /* å­—ä½“æ ˆ */
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "Segoe UI", Roboto, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body { 
            font-family: var(--font-stack); 
            background-color: var(--bg-body); 
            margin: 0; 
            padding: 60px 40px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased; /* è®©å­—ä½“æ›´æ¸…æ™° */
        }
        
        .hidden { display: none !important; }

        /* æ°´å° (è°ƒæ•´é€æ˜åº¦ 0.08 -> 0.18) */
        .watermark {
            position: fixed; 
            font-size: 12px; 
            font-weight: 600;
            color: rgba(0, 0, 0, 0.18); /* ç¨å¾®åŠ æ·± */
            pointer-events: none; 
            z-index: 9999;
            font-family: var(--font-stack); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            text-align: right;
        }
        .wm-top { top: 20px; right: 30px; }
        .wm-bottom { bottom: 20px; right: 30px; }

        /* å¤´éƒ¨ */
        .header { text-align: center; margin-bottom: 50px; width: 100%; position: relative; max-width: 1200px; animation: fadeIn 0.8s ease; }
        h1 { font-size: 32px; font-weight: 700; margin: 0; letter-spacing: -0.02em; color: var(--text-primary); }
        p { color: var(--text-secondary); font-size: 17px; margin-top: 10px; font-weight: 400; }
        
        /* è¿”å›æŒ‰é’® (æ¯›ç»ç’ƒæ•ˆæœ) */
        .btn-back { 
            position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);
            color: var(--text-primary); border: 1px solid rgba(0,0,0,0.05); 
            padding: 10px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 500; 
            transition: all 0.2s cubic-bezier(0.25,0.1,0.25,1); display: flex; align-items: center; gap: 6px;
        }
        .btn-back:hover { background: #fff; box-shadow: var(--shadow-sm); transform: translateY(-50%) scale(1.02); }

        /* ä»ªè¡¨ç›˜ Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; width: 100%; max-width: 1200px; }
        
        /* æ¨¡å—å¡ç‰‡ (Apple Card Style) */
        .module-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            cursor: pointer; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            display: flex; flex-direction: column; overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.02);
            height: 100%;
        }
        .module-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }

        /* å¡ç‰‡è¿›åº¦åŒº */
        .card-stats { padding: 24px 24px 10px 24px; border-bottom: 1px solid #F5F5F7; }
        .stats-label { font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; display: flex; justify-content: space-between; margin-bottom: 8px; letter-spacing: 0.5px; }
        .stats-value { font-size: 28px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; }
        
        /* è¿›åº¦æ¡ (æ›´ç»†ã€æ›´åœ†) */
        .progress-bar-bg { width: 100%; height: 4px; background: #F2F2F2; border-radius: 2px; margin-top: 12px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 2px; width: 0%; transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1); }
        .fill-order { background: var(--color-order); }
        .fill-drawing { background: var(--color-drawing); }
        .fill-delivery { background: var(--color-delivery); }
        .fill-ncr { background: var(--color-ncr); }

        /* å¡ç‰‡å†…å®¹åŒº */
        .card-content { padding: 30px 24px; display: flex; flex-direction: column; align-items: center; text-align: center; flex: 1; }
        
        /* å›¾æ ‡å®¹å™¨ (åœ†å½¢èƒŒæ™¯) */
        .icon-container {
            width: 64px; height: 64px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; margin-bottom: 16px;
        }
        .card-order .icon-container { background: var(--color-order-bg); color: var(--color-order); }
        .card-drawing .icon-container { background: var(--color-drawing-bg); color: var(--color-drawing); }
        .card-delivery .icon-container { background: var(--color-delivery-bg); color: var(--color-delivery); }
        .card-ncr .icon-container { background: var(--color-ncr-bg); color: var(--color-ncr); }

        .card-title { font-size: 19px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .card-desc { color: var(--text-secondary); font-size: 14px; line-height: 1.5; font-weight: 400; }

        /* ================= æ¨¡å—å†…éƒ¨å¸ƒå±€ ================= */
        .main-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; width: 100%; max-width: 1900px; animation: fadeInUp 0.5s ease; }
        
        .panel-box { 
            background: var(--bg-card); 
            padding: 30px; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        .canvas-wrapper { flex: 0 0 auto; display: flex; justify-content: center; overflow-x: auto; align-items: flex-start; }
        .data-panel { flex: 1 1 800px; min-width: 600px; max-height: 850px; overflow-y: auto; display: flex; flex-direction: column; }
        .data-panel.full-width { flex: 1 1 100%; max-width: 1600px; min-width: 1000px; }

        /* Tabs (iOS Segmented Control é£æ ¼) */
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .tower-tabs { 
            display: inline-flex; 
            background: #F0F0F2; 
            padding: 3px; 
            border-radius: 9px; 
        }
        .tab-btn { 
            padding: 6px 24px; 
            cursor: pointer; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border: none; 
            background: transparent; 
            font-size: 13px; 
            border-radius: 7px; 
            transition: all 0.2s ease;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { 
            color: #000; 
            background: #fff; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
            font-weight: 600;
        }

        /* æŒ‰é’® (Apple Style Button) */
        .btn-add-row { 
            background: #FF3B30; color: white; border: none; padding: 8px 16px; border-radius: 18px; 
            cursor: pointer; font-weight: 500; font-size: 13px; display: flex; align-items: center; gap: 6px; 
            transition: background 0.2s; 
        }
        .btn-add-row:hover { background: #D72C22; }

        /* Table (æç®€é£æ ¼) */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; table-layout: fixed; }
        
        th { 
            position: sticky; top: 0; z-index: 10; 
            background: rgba(249, 249, 249, 0.95); backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒè¡¨å¤´ */
            color: var(--text-secondary); 
            padding: 14px 10px; 
            font-weight: 600; 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            border-bottom: 1px solid #E5E5EA; 
            text-align: center;
        }
        
        td { 
            border-bottom: 1px solid #F2F2F7; 
            padding: 10px; 
            text-align: center; 
            vertical-align: middle; 
            color: var(--text-primary); 
            background: white;
            transition: background 0.1s;
        }
        tr:hover td { background-color: #F9F9F9 !important; }
        
        /* æ¥¼å±‚åˆ—ç‰¹æ®Šå¤„ç† */
        td strong { font-weight: 600; font-feature-settings: "tnum"; color: var(--text-primary); }

        /* NCR Row Styles */
        .ncr-status-row td { background: #FAFAFA; border-bottom: 1px solid #E5E5EA; padding: 10px 20px; text-align: left; }
        .ncr-status-row.resolved td { background: #F2FBF5; }
        .ncr-data-row.resolved textarea, .ncr-data-row.resolved input { opacity: 0.5; text-decoration: line-through; }

        /* Inputs (iOS Input Style) */
        .cell-content { display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        input[type="checkbox"] { 
            appearance: none; -webkit-appearance: none;
            width: 18px; height: 18px; border-radius: 4px; border: 1px solid #C7C7CC; cursor: pointer;
            position: relative; transition: all 0.2s;
        }
        input[type="checkbox"]:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        input[type="checkbox"]:checked::after { content: 'âœ“'; position: absolute; color: white; font-size: 12px; left: 3px; top: 0px; }

        input.mini-input, input.date-input, textarea { 
            width: 100%; padding: 8px 10px; 
            border: 1px solid transparent; 
            background: #F2F2F7; /* æµ…ç°èƒŒæ™¯ */
            border-radius: 8px; 
            font-size: 13px; 
            text-align: center; 
            font-family: inherit; 
            color: var(--text-primary);
            transition: all 0.2s;
        }
        input.mini-input:focus, input.date-input:focus, textarea:focus { 
            background: #fff; border-color: var(--accent-blue); 
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); 
        }
        
        textarea.auto-resize { resize: none; overflow: hidden; min-height: 36px; line-height: 1.5; text-align: left; }
        
        .delete-btn { color: #FF3B30; opacity: 0.6; cursor: pointer; border: none; background: none; font-size: 16px; transition: 0.2s; }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }

        /* Delivery å¾½æ ‡ */
        .type-a-badge { color: #ff7f50; font-weight: 600; background: #fff0eb; padding: 2px 6px; border-radius: 4px; }
        .type-b-badge { color: #1abc9c; font-weight: 600; background: #e0f7f3; padding: 2px 6px; border-radius: 4px; }
        .sep-line { border-left: 1px solid #E5E5EA; }

        /* Action Bar (åº•éƒ¨æ‚¬æµ®æ ) */
        .action-bar { 
            width: 100%; max-width: 1900px; margin-top: 30px; padding: 20px 30px; 
            background: var(--bg-card); border-radius: var(--radius-lg); 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: var(--shadow-lg); 
            position: sticky; bottom: 20px; z-index: 99; /* æ‚¬æµ®æ•ˆæœ */
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        .btn-group-right, .btn-group-left { display: flex; gap: 16px; align-items: center; }
        
        button.action-btn { 
            border: none; padding: 10px 20px; border-radius: 20px; /* èƒ¶å›ŠæŒ‰é’® */
            font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 14px; 
            display: flex; align-items: center; gap: 8px; 
        }
        
        .btn-save { background-color: var(--accent-blue); color: white; }
        .btn-save:hover { background-color: var(--accent-blue-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3); }
        
        .btn-excel-export { background-color: #34c759; color: white; }
        .btn-excel-export:hover { background-color: #30b753; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3); }
        
        .btn-excel-import { background-color: #fff; color: var(--text-primary); border: 1px solid #d1d1d6; }
        .btn-excel-import:hover { background-color: #f2f2f7; border-color: #8e8e93; }
        
        #fileInput { display: none; }

        /* åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="wm-top" class="watermark wm-top"></div>
<div id="wm-bottom" class="watermark wm-bottom"></div>

<!-- 1. ä¸»é¡µ (Dashboard) -->
<div id="view-home" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
    <div class="header">
        <h1>è²å¾‹å®¾BPOé¡¹ç›®æ€»æ§ä»ªè¡¨ç›˜</h1>
        <p>Unitized Curtain Wall Project | T4 & T5 Towers</p>
    </div>

    <div class="dashboard-grid">
        <!-- æ¨¡å— 1 -->
        <div class="module-card card-order" onclick="enterModule('order')">
            <div class="card-stats">
                <div class="stats-label">æ€»ä¸‹å•å®Œæˆç‡ <span id="stat-order-val">0%</span></div>
                <div class="progress-bar-bg"><div id="stat-order-bar" class="progress-bar-fill fill-order"></div></div>
            </div>
            <div class="card-content">
                <div class="icon-container">ğŸ“¦</div>
                <div class="card-title">ä¸‹å•è¿›åº¦ç»Ÿè®¡è¡¨</div>
                <div class="card-desc">å…¨ææ–™ä¸‹å•ã€åˆ°è´§ä¸åº“å­˜è¿½è¸ª<br>æ”¯æŒå¤šç»´åº¦åŒæ­¥ç®¡ç†</div>
            </div>
        </div>

        <!-- æ¨¡å— 2 -->
        <div class="module-card card-drawing" onclick="enterModule('drawing')">
            <div class="card-stats">
                <div class="stats-label">åŠ å·¥å›¾æäº¤ç‡ <span id="stat-drawing-val">0%</span></div>
                <div class="progress-bar-bg"><div id="stat-drawing-bar" class="progress-bar-fill fill-drawing"></div></div>
            </div>
            <div class="card-content">
                <div class="icon-container">ğŸ“</div>
                <div class="card-title">åŠ å·¥å›¾æäº¤è®°å½•è¡¨</div>
                <div class="card-desc">åŠ å·¥å›¾æå›¾ã€ä¿®å›¾ã€å®šç‰ˆå…¨æµç¨‹<br>ç‹¬ç«‹æ¥¼æ ‹ç®¡ç†</div>
            </div>
        </div>

        <!-- æ¨¡å— 3 -->
        <div class="module-card card-delivery" onclick="enterModule('delivery')">
            <div class="card-stats">
                <div class="stats-label">æ•´ä½“å‘è´§å®Œæˆç‡ <span id="stat-delivery-val">0%</span></div>
                <div class="progress-bar-bg"><div id="stat-delivery-bar" class="progress-bar-fill fill-delivery"></div></div>
            </div>
            <div class="card-content">
                <div class="icon-container">ğŸš¢</div>
                <div class="card-title">äº¤ä»˜è®¡åˆ’è¡¨</div>
                <div class="card-desc">ETD æ’æœŸã€æ’äº§ä¸å‘è´§ç®¡ç†<br>å¯è§†åŒ–ç±»å‹å æ¯”åˆ†æ</div>
            </div>
        </div>

        <!-- æ¨¡å— 4 (NCR) -->
        <div class="module-card card-ncr" onclick="enterModule('ncr')">
            <div class="card-stats">
                <div class="stats-label">ç´¯è®¡æŠ¥å‘Šæ€»æ•°</div>
                <div class="stats-value" id="stat-ncr-val">0</div>
            </div>
            <div class="card-content">
                <div class="icon-container">âš ï¸</div>
                <div class="card-title">è´¨æ£€æŠ•è¯‰NCRåˆé›†</div>
                <div class="card-desc">NCR ç¼–å·ã€è¯¦æƒ…ä¸è´£ä»»æ–¹è¿½è¸ª<br>æ–‡å­—è®°å½•ä¸æ¸…å•ç®¡ç†</div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 60px; color: #a1a1a6; font-size: 12px; font-family: monospace;">
        SYSTEM V23.0 | DESIGNED BY DEREK YE
    </div>
</div>

<!-- 2. é€šç”¨æ¨¡å—ç•Œé¢ -->
<div id="view-module" class="hidden" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
    <div class="header" style="margin-bottom: 30px;">
        <button class="btn-back" onclick="goHome()">
            <span>â®</span> ä»ªè¡¨ç›˜
        </button>
        <h1 id="module-title">æ¨¡å—æ ‡é¢˜</h1>
        <p id="module-subtitle">Unitized Curtain Wall Project | T4 & T5 Towers</p>
    </div>

    <div class="main-container">
        <!-- Canvas -->
        <div id="wrapper-canvas" class="canvas-wrapper panel-box">
            <canvas id="buildingCanvas"></canvas>
        </div>

        <!-- Data Panel -->
        <div id="wrapper-data" class="data-panel panel-box">
            <div class="panel-header">
                <div id="tower-tabs" class="tower-tabs hidden">
                    <button class="tab-btn active" onclick="switchTab('T4')">T4 å¡”æ¥¼</button>
                    <button class="tab-btn" onclick="switchTab('T5')">T5 å¡”æ¥¼</button>
                </div>
                <!-- NCR æ–°å¢æŒ‰é’® -->
                <div id="ncr-controls" class="hidden">
                    <button class="btn-add-row" onclick="addNcrRow()">
                        <span>+</span> æ–°å¢æŠ¥å‘Š (New Row)
                    </button>
                </div>
            </div>
            
            <table id="dataTable">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="action-bar">
        <div class="btn-group-left">
            <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFileImport(this)">
            <button class="btn-excel-import action-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å¯¼å…¥</button>
            <button class="btn-excel-export action-btn" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
        </div>
        <div class="btn-group-right">
            <span style="margin-right: 10px; color: var(--text-secondary); font-size: 13px;">
                è‡ªåŠ¨åŒæ­¥ä¸­
            </span>
            <button class="btn-save action-btn" onclick="saveAsNewHtml()">ğŸ’¾ ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>

<script id="app-logic">
    // ================= 0. æ°´å°ä¸ UI åˆå§‹åŒ– =================
    function updateWatermark(viewName) {
        const date = new Date();
        const dateStr = `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
        const text = `DEREK YE/BPO  |  ${viewName}  |  ${dateStr}`;
        
        document.getElementById('wm-top').innerText = text;
        document.getElementById('wm-bottom').innerText = text;
    }

    function autoResize(el) {
        el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px';
    }

    function getBeijingTimeStr() {
        const now = new Date(); const offset = 8; const utc = now.getTime() + (now.getTimezoneOffset() * 60000); const bj = new Date(utc + (3600000 * offset));
        const y = bj.getFullYear(); const m = String(bj.getMonth() + 1).padStart(2, '0'); const d = String(bj.getDate()).padStart(2, '0');
        const hh = String(bj.getHours()).padStart(2, '0'); const mm = String(bj.getMinutes()).padStart(2, '0');
        return `${y}${m}${d}_${hh}${mm}`;
    }

    // ================= 1. é…ç½®ä¸­å¿ƒ =================
    const COMMON_CFG = { floors: [], towers: ['T4', 'T5'] };
    for (let i = 1; i <= 27; i++) { if (i !== 13) COMMON_CFG.floors.push(i); }

    const CONFIG_ORDER = { id: 'order', title: 'ä¸‹å•è¿›åº¦ç»Ÿè®¡è¡¨', type: 'synced',
        cols: [ { key: 'profile', name: 'å‹æ', color: '#3498db' }, { key: 'glass', name: 'ç»ç’ƒ', color: '#81ecec' }, { key: 'gasket', name: 'èƒ¶æ¡', color: '#e67e22' }, { key: 'fastener', name: 'ç´§å›ºä»¶', color: '#9b59b6' }, { key: 'panel', name: 'é“æ¿', color: '#e74c3c' }, { key: 'sealant', name: 'ç¡…é…®èƒ¶', color: '#f1c40f' }, { key: 'access', name: 'è¾…æ–™', color: '#2ecc71' }, { key: 'hardware', name: 'äº”é‡‘', color: '#34495e' } ]
    };
    const CONFIG_DRAWING = { id: 'drawing', title: 'åŠ å·¥å›¾æäº¤è®°å½•è¡¨', type: 'separate' };
    const CONFIG_DELIVERY = { id: 'delivery', title: 'äº¤ä»˜è®¡åˆ’è¡¨', type: 'separate' };
    const CONFIG_NCR = { id: 'ncr', title: 'è´¨æ£€æŠ•è¯‰NCRåˆé›†', type: 'list',
        cols: ['æŠ¥å‘Šæ—¥æœŸ', 'ç¼ºé™·ç¼–å· (NCR No.)', 'ææ–™ç±»å‹', 'ç¼ºé™·è¯¦æƒ…æè¿°ï¼ˆæ‘˜è¦ï¼‰', 'ç¼ºé™·ç¼–å· Code', 'æ•°é‡ QTY', 'è´£ä»»æ–¹']
    };
    
    const PRESET_PLAN_DATES = { 1: "2025-11-10", 8: "2025-12-05", 14: "2026-01-09", 26: "2026-04-16" };
    function getPresetDelivery(floor) {
        if (floor <= 6) return { etd: "2025-12-01", a: 19, b: 7 };
        if (floor <= 8) return { etd: "2026-01-01", a: 60, b: 96 };
        if (floor === 9) return { etd: "2026-01-17", a: 37, b: 119 };
        if (floor === 10) return { etd: "2026-01-17", a: 60, b: 96 };
        if (floor <= 12) return { etd: "2026-02-19", a: 60, b: 96 };
        if (floor <= 14) return { etd: "2026-03-24", a: 60, b: 96 };
        if (floor === 15) return { etd: "2026-03-24", a: 37, b: 119 };
        return { etd: "2026-04-01", a: 60, b: 96 }; 
    }

    const PRESET_NCR = [
        { date: '20251125', no: 'NP-BPO-003', mat: '8mmå•ç»', desc: 'æ ‡ç­¾å°ºå¯¸é”™è¯¯ï¼ˆæ ‡ç­¾å°ºå¯¸617*1368mmï¼Œå®é™…ç»ç’ƒå°ºå¯¸617*1364mmï¼‰ï¼›Logoåœ¨å®‰è£…æ—¶å®¹æ˜“è¢«æ¸…é™¤æ‰ã€‚', code: 'T4-GM-SE-002-G4=1, T4-GM-SE-002-G2=1...', qty: 'å…±6ä»¶', party: 'æ–°ç¦å…´ç»ç’ƒæœ‰é™å…¬å¸', solved: false },
        { date: '20251126', no: 'NP-BPO-004', mat: 'é“æ¿', desc: 'è‰²å·®ä¸ç¬¦åˆæ ·æ¿ï¼ˆå·²é€€è´§è¿”å–·ï¼‰ï¼›åˆ°è´§é“æ¿æœªé‡‡å–ä»»ä½•ä¿æŠ¤æªæ–½ï¼Œå¯¼è‡´æ¿é¢åˆ®ä¼¤ä¸¥é‡ã€‚', code: '(æœªæä¾›å…·ä½“ç¼–å·)', qty: 'å…±96ä»¶', party: 'äº’åˆ©é’¢æ„', solved: true },
        { date: '20251128', no: 'NP-BPO-005', mat: 'ç»ç’ƒ', desc: 'å†…éƒ¨æ‚ç‰©ï¼Œç¼ºé™·ç…§ç‰‡æ— æ³•æ‹å‡ºã€‚', code: 'T4-2F-SE-007-G2 1614X1468=1...', qty: 'å…±3ä»¶', party: 'æ–°ç¦å…´ç»ç’ƒæœ‰é™å…¬å¸', solved: false }
    ];

    // ================= 2. æ•°æ®åˆå§‹åŒ– =================
    function initOrderData() {
        let data = {};
        COMMON_CFG.floors.forEach(f => { data[f] = {}; CONFIG_ORDER.cols.forEach(c => data[f][c.key] = { c: false, t: "" }); });
        return data;
    }
    function initDrawingData() {
        let data = { T4: {}, T5: {} };
        ['T4', 'T5'].forEach(tower => { COMMON_CFG.floors.forEach(f => {
                data[tower][f] = { plan: PRESET_PLAN_DATES[f] || "2026-01-01", subC: false, subD: "", apprC: false, apprD: "" };
        }); });
        return data;
    }
    function initDeliveryData() {
        let data = { T4: {}, T5: {} };
        ['T4', 'T5'].forEach(tower => { COMMON_CFG.floors.forEach(f => {
                const p = getPresetDelivery(f);
                data[tower][f] = { etd: p.etd, typeA: p.a, typeB: p.b, total: p.a + p.b, prodC: false, shipD: "", shipC: false, realShipD: "" };
        }); });
        return data;
    }
    function initNcrData() { return JSON.parse(JSON.stringify(PRESET_NCR)); }

    const savedSnapshot = null;
    let GLOBAL_DATA = savedSnapshot || { order: initOrderData(), drawing: initDrawingData(), delivery: initDeliveryData(), ncr: initNcrData() };
    if (!GLOBAL_DATA.delivery) GLOBAL_DATA.delivery = initDeliveryData();
    if (!GLOBAL_DATA.ncr) GLOBAL_DATA.ncr = initNcrData();

    // ================= 3. é¦–é¡µç»Ÿè®¡ =================
    function renderDashboardStats() {
        // Order
        let orderT = 0, orderC = 0;
        COMMON_CFG.floors.forEach(f => { CONFIG_ORDER.cols.forEach(c => { orderT++; if (GLOBAL_DATA.order[f][c.key].c) orderC++; }); });
        const orderPct = orderT ? Math.round((orderC / orderT) * 100) : 0;
        document.getElementById('stat-order-val').innerText = orderPct + '%';
        document.getElementById('stat-order-bar').style.width = orderPct + '%';

        // Drawing
        let drawT = 0, drawC = 0;
        ['T4', 'T5'].forEach(t => { COMMON_CFG.floors.forEach(f => { drawT++; if (GLOBAL_DATA.drawing[t][f].subC) drawC++; }); });
        const drawPct = drawT ? Math.round((drawC / drawT) * 100) : 0;
        document.getElementById('stat-drawing-val').innerText = drawPct + '%';
        document.getElementById('stat-drawing-bar').style.width = drawPct + '%';

        // Delivery
        let delT = 0, delC = 0;
        ['T4', 'T5'].forEach(t => { COMMON_CFG.floors.forEach(f => { delT++; if (GLOBAL_DATA.delivery[t][f].shipC) delC++; }); });
        const delPct = delT ? Math.round((delC / delT) * 100) : 0;
        document.getElementById('stat-delivery-val').innerText = delPct + '%';
        document.getElementById('stat-delivery-bar').style.width = delPct + '%';

        // NCR
        document.getElementById('stat-ncr-val').innerText = GLOBAL_DATA.ncr.length;
    }

    // ================= 4. çŠ¶æ€ç®¡ç† =================
    let CTX = { module: 'order', activeTower: 'T4' };

    function enterModule(mod) {
        CTX.module = mod;
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-module').classList.remove('hidden');
        
        let cfg, isNcr = (mod === 'ncr');
        if (mod === 'order') cfg = CONFIG_ORDER;
        else if (mod === 'drawing') cfg = CONFIG_DRAWING;
        else if (mod === 'delivery') cfg = CONFIG_DELIVERY;
        else cfg = CONFIG_NCR;

        document.getElementById('module-title').innerText = cfg.title;
        updateWatermark(cfg.title.toUpperCase()); 
        
        const canvasEl = document.getElementById('wrapper-canvas');
        const dataEl = document.getElementById('wrapper-data');
        const tabEl = document.getElementById('tower-tabs');
        const ncrControls = document.getElementById('ncr-controls');

        if (isNcr) {
            canvasEl.classList.add('hidden');
            dataEl.classList.add('full-width');
            tabEl.classList.add('hidden');
            ncrControls.classList.remove('hidden');
            initTable(); 
        } else {
            canvasEl.classList.remove('hidden');
            dataEl.classList.remove('full-width');
            ncrControls.classList.add('hidden');
            
            if (mod !== 'order') {
                tabEl.classList.remove('hidden');
                switchTab('T4'); 
            } else {
                tabEl.classList.add('hidden');
                initTable();
                resizeCanvas();
            }
        }
    }

    function goHome() {
        document.getElementById('view-module').classList.add('hidden');
        document.getElementById('view-home').classList.remove('hidden');
        updateWatermark("DASHBOARD HOME");
        renderDashboardStats(); 
    }

    function switchTab(tower) {
        CTX.activeTower = tower;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(tower)));
        initTable();
        resizeCanvas();
    }

    // ================= 5. è¡¨æ ¼é€»è¾‘ =================
    function initTable() {
        const thead = document.getElementById('table-head');
        const tbody = document.getElementById('table-body');
        
        if (CTX.module === 'order') renderOrderTable(thead, tbody);
        else if (CTX.module === 'drawing') renderDrawingTable(thead, tbody);
        else if (CTX.module === 'delivery') renderDeliveryTable(thead, tbody);
        else renderNcrTable(thead, tbody);
    }

    function renderOrderTable(thead, tbody) {
        thead.innerHTML = `<tr><th style="width:50px;">F</th>${CONFIG_ORDER.cols.map(c=>`<th>${c.name}</th>`).join('')}</tr>`;
        tbody.innerHTML = '';
        [...COMMON_CFG.floors].reverse().forEach(f => {
            const tr = document.createElement('tr'); tr.innerHTML = `<td><strong>${f}F</strong></td>`;
            CONFIG_ORDER.cols.forEach(col => {
                const item = GLOBAL_DATA.order[f][col.key]; const td = document.createElement('td'); const div = document.createElement('div'); div.className = 'cell-content';
                const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = item.c; chk.onchange = function() { item.c = this.checked; drawAll(); };
                const inp = document.createElement('input'); inp.type = 'text'; inp.className = 'mini-input'; inp.value = item.t || ""; inp.oninput = function() { item.t = this.value; };
                div.append(chk, inp); td.appendChild(div); tr.appendChild(td);
            }); tbody.appendChild(tr);
        });
    }
    function renderDrawingTable(thead, tbody) {
        thead.innerHTML = `<tr><th style="width:60px;">æ¥¼å±‚</th><th style="width:130px;">è®¡åˆ’æäº¤æ—¶é—´</th><th style="width:200px;">æäº¤çŠ¶æ€ & æ—¥æœŸ</th><th style="width:200px;">æ‰¹å¤çŠ¶æ€ & æ—¥æœŸ</th></tr>`;
        tbody.innerHTML = '';
        [...COMMON_CFG.floors].reverse().forEach(f => {
            const item = GLOBAL_DATA.drawing[CTX.activeTower][f];
            const tr = document.createElement('tr'); tr.innerHTML = `<td><strong>${f}F</strong></td><td><span class="readonly-text">${item.plan||'-'}</span></td>`;
            const tdS = document.createElement('td'), dS = document.createElement('div'); dS.className='cell-content';
            const cS = document.createElement('input'); cS.type='checkbox'; cS.checked=item.subC; cS.onchange=function(){item.subC=this.checked;drawAll();};
            const iS = document.createElement('input'); iS.className='mini-input date-input'; iS.value=item.subD; iS.oninput=function(){item.subD=this.value;drawAll();};
            dS.append(cS,iS); tdS.appendChild(dS);
            const tdA = document.createElement('td'), dA = document.createElement('div'); dA.className='cell-content';
            const cA = document.createElement('input'); cA.type='checkbox'; cA.checked=item.apprC; cA.onchange=function(){item.apprC=this.checked;drawAll();};
            const iA = document.createElement('input'); iA.className='mini-input date-input'; iA.value=item.apprD; iA.oninput=function(){item.apprD=this.value;drawAll();};
            dA.append(cA,iA); tdA.appendChild(dA);
            tr.append(tdS, tdA); tbody.appendChild(tr);
        });
    }
    function renderDeliveryTable(thead, tbody) {
        thead.innerHTML = `<tr><th style="width:50px;">F</th><th>æ€»æ•°é‡</th><th style="color:var(--prod-a)">Aç±»å‹</th><th style="color:var(--prod-b)">Bç±»å‹</th><th>ETD</th><th class="sep-line">å·²æ’äº§</th><th>è®¡åˆ’å‘è´§</th><th class="sep-line">å·²å‘è´§</th><th>å‘è´§æ—¥æœŸ</th></tr>`;
        tbody.innerHTML = '';
        [...COMMON_CFG.floors].reverse().forEach(f => {
            const item = GLOBAL_DATA.delivery[CTX.activeTower][f];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${f}F</strong></td><td>${item.total}</td><td class="type-a-badge">${item.typeA}</td><td class="type-b-badge">${item.typeB}</td><td><span class="readonly-text">${item.etd||'-'}</span></td>`;
            const tdP = document.createElement('td'); tdP.className='sep-line'; const cP=document.createElement('input'); cP.type='checkbox'; cP.checked=item.prodC; cP.onchange=function(){item.prodC=this.checked;drawAll();}; tdP.appendChild(cP); tr.appendChild(tdP);
            const tdS = document.createElement('td'); const iS=document.createElement('input'); iS.className='mini-input date-input'; iS.value=item.shipD; iS.oninput=function(){item.shipD=this.value;drawAll();}; tdS.appendChild(iS); tr.appendChild(tdS);
            const tdR = document.createElement('td'); tdR.className='sep-line'; const cR=document.createElement('input'); cR.type='checkbox'; cR.checked=item.shipC; cR.onchange=function(){item.shipC=this.checked;drawAll();}; tdR.appendChild(cR); tr.appendChild(tdR);
            const tdD = document.createElement('td'); const iD=document.createElement('input'); iD.className='mini-input date-input'; iD.value=item.realShipD||""; iD.oninput=function(){item.realShipD=this.value;drawAll();}; tdD.appendChild(iD); tr.appendChild(tdD);
            tbody.appendChild(tr);
        });
    }
    function renderNcrTable(thead, tbody) {
        let headers = CONFIG_NCR.cols.map((c, i) => {
            let width = '100px'; if (i===3) width = '350px'; if (i===4) width = '250px';
            return `<th style="width:${width};">${c}</th>`;
        }).join(''); headers += `<th style="width:50px;">åˆ é™¤</th>`; 
        thead.innerHTML = `<tr>${headers}</tr>`;
        tbody.innerHTML = '';
        GLOBAL_DATA.ncr.forEach((row, idx) => {
            const trData = document.createElement('tr');
            trData.className = 'ncr-data-row' + (row.solved ? ' resolved' : '');
            const createCell = (key, isArea=false) => {
                const td = document.createElement('td');
                const inp = isArea ? document.createElement('textarea') : document.createElement('input');
                inp.className = isArea ? 'auto-resize' : 'mini-input';
                inp.value = row[key] || "";
                if (isArea) { inp.oninput = function() { autoResize(this); row[key] = this.value; }; setTimeout(() => autoResize(inp), 0); } 
                else { inp.oninput = function() { row[key] = this.value; }; }
                td.appendChild(inp); return td;
            };
            trData.appendChild(createCell('date')); trData.appendChild(createCell('no')); trData.appendChild(createCell('mat'));
            trData.appendChild(createCell('desc', true)); trData.appendChild(createCell('code', true));
            trData.appendChild(createCell('qty')); trData.appendChild(createCell('party'));
            const tdDel = document.createElement('td');
            const btnDel = document.createElement('button'); btnDel.className = 'delete-btn'; btnDel.innerHTML = 'ğŸ—‘';
            btnDel.onclick = function() { if(confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤æ­¤ NCR è®°å½•å—ï¼Ÿ')) { GLOBAL_DATA.ncr.splice(idx, 1); renderNcrTable(thead, tbody); } };
            tdDel.appendChild(btnDel); trData.appendChild(tdDel);
            const trStatus = document.createElement('tr');
            trStatus.className = 'ncr-status-row' + (row.solved ? ' resolved' : '');
            const tdStatus = document.createElement('td'); tdStatus.colSpan = 8;
            const divStatus = document.createElement('div');
            divStatus.style.display = 'flex'; divStatus.style.alignItems = 'center'; divStatus.style.gap = '8px'; divStatus.style.justifyContent = 'flex-end';
            const chkSolved = document.createElement('input'); chkSolved.type = 'checkbox'; chkSolved.checked = row.solved;
            chkSolved.onchange = function() { row.solved = this.checked; renderNcrTable(thead, tbody); };
            const lblSolved = document.createElement('span');
            lblSolved.innerText = row.solved ? "âœ… å·²è§£å†³ (Resolved)" : "â¬œ å¾…è§£å†³ (Pending)";
            lblSolved.style.fontWeight = "600"; lblSolved.style.color = row.solved ? "#34c759" : "#8e8e93";
            divStatus.append(chkSolved, lblSolved); tdStatus.appendChild(divStatus); trStatus.appendChild(tdStatus);
            tbody.append(trData, trStatus);
        });
    }
    function addNcrRow() {
        GLOBAL_DATA.ncr.push({ date:'', no:'', mat:'', desc:'', code:'', qty:'', party:'', solved: false });
        renderNcrTable(document.getElementById('table-head'), document.getElementById('table-body'));
    }

    // ================= 6. Canvas å¯è§†åŒ– =================
    const canvas = document.getElementById('buildingCanvas');
    const ctx = canvas.getContext('2d');
    const DRAW_CFG = { floorHeight: 24, towerWidth: 300, gap: 150, paddingTop: 150, paddingBottom: 50, paddingX: 80, roofHeight: 30 };

    function resizeCanvas() {
        if (CTX.module === 'ncr') return;
        const totalHeight = COMMON_CFG.floors.length * DRAW_CFG.floorHeight + DRAW_CFG.paddingTop + DRAW_CFG.paddingBottom;
        const totalWidth = DRAW_CFG.paddingX * 2 + DRAW_CFG.towerWidth * 2 + DRAW_CFG.gap;
        canvas.width = totalWidth; canvas.height = totalHeight;
        canvas.style.width = totalWidth + "px"; canvas.style.height = totalHeight + "px";
        drawAll();
    }

    function drawAll() {
        if (CTX.module === 'ncr') return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (CTX.module === 'order') {
            drawOrderBuilding('T4 Tower', DRAW_CFG.paddingX); drawOrderBuilding('T5 Tower', DRAW_CFG.paddingX + DRAW_CFG.towerWidth + DRAW_CFG.gap);
        } else if (CTX.module === 'drawing') {
            drawDrawingBuilding('T4', DRAW_CFG.paddingX); drawDrawingBuilding('T5', DRAW_CFG.paddingX + DRAW_CFG.towerWidth + DRAW_CFG.gap); drawDrawingLegend();
        } else {
            drawDeliveryBuilding('T4', DRAW_CFG.paddingX); drawDeliveryBuilding('T5', DRAW_CFG.paddingX + DRAW_CFG.towerWidth + DRAW_CFG.gap); drawDeliveryLegend();
        }
    }

    // Order ç»˜å›¾ (V21: å­—ä½“ä¸é¢œè‰²å¾®è°ƒ)
    function drawOrderBuilding(name, x) {
        const bottomY = canvas.height - DRAW_CFG.paddingBottom;
        const topY = bottomY - COMMON_CFG.floors.length * DRAW_CFG.floorHeight;
        const cellWidth = DRAW_CFG.towerWidth / CONFIG_ORDER.cols.length;
        ctx.fillStyle = '#1d1d1f'; ctx.font = 'bold 18px -apple-system'; ctx.textAlign = 'center'; ctx.fillText(name, x + DRAW_CFG.towerWidth/2, topY - DRAW_CFG.roofHeight - 65);
        CONFIG_ORDER.cols.forEach((c, idx) => {
            const cx = x + idx * cellWidth + cellWidth/2; const ly = topY - DRAW_CFG.roofHeight - 15;
            ctx.fillStyle = c.color; ctx.fillRect(cx - 5, ly - 12, 10, 10);
            ctx.fillStyle = '#86868b'; ctx.font = '10px -apple-system'; ctx.textAlign = 'center'; ctx.fillText(c.name, cx, ly - 15);
            ctx.beginPath(); ctx.setLineDash([2, 2]); ctx.moveTo(cx, ly); ctx.lineTo(cx, topY - DRAW_CFG.roofHeight); ctx.strokeStyle = 'rgba(0,0,0,0.05)'; ctx.stroke(); ctx.setLineDash([]);
        });
        ctx.beginPath(); ctx.moveTo(x - 10, topY); ctx.lineTo(x + DRAW_CFG.towerWidth/2, topY - DRAW_CFG.roofHeight); ctx.lineTo(x + DRAW_CFG.towerWidth + 10, topY); ctx.closePath(); ctx.fillStyle = '#2c3e50'; ctx.fill();
        COMMON_CFG.floors.forEach((f, idx) => {
            const y = bottomY - (idx + 1) * DRAW_CFG.floorHeight;
            ctx.fillStyle = '#86868b'; ctx.textAlign = 'right'; ctx.font = '500 11px -apple-system'; ctx.fillText(f + "F", x - 5, y + 16);
            CONFIG_ORDER.cols.forEach((c, cIdx) => {
                const cx = x + cIdx * cellWidth; const item = GLOBAL_DATA.order[f][c.key];
                ctx.fillStyle = item.c ? c.color : (idx%2 ? '#fff':'#fafafa');
                ctx.fillRect(cx, y, cellWidth, DRAW_CFG.floorHeight);
                ctx.strokeStyle = 'rgba(0,0,0,0.03)'; ctx.lineWidth = 1; ctx.strokeRect(cx, y, cellWidth, DRAW_CFG.floorHeight);
            });
        });
        ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 1; ctx.strokeRect(x, topY, DRAW_CFG.towerWidth, bottomY - topY);
    }

    function drawDrawingBuilding(towerName, x) {
        const bottomY = canvas.height - DRAW_CFG.paddingBottom; const data = GLOBAL_DATA.drawing[towerName];
        ctx.fillStyle = '#1d1d1f'; ctx.font = 'bold 20px -apple-system'; ctx.textAlign = 'center'; ctx.fillText(towerName + " Tower", x + DRAW_CFG.towerWidth/2, DRAW_CFG.paddingTop - 40);
        ctx.font = '12px -apple-system'; ctx.fillStyle = '#86868b'; ctx.textAlign = 'left'; ctx.fillText("æœŸé—´ (å¤©)", x + DRAW_CFG.towerWidth + 10, DRAW_CFG.paddingTop - 10);
        COMMON_CFG.floors.forEach((f, idx) => {
            const y = bottomY - (idx + 1) * DRAW_CFG.floorHeight; const item = data[f];
            let bg = '#fff'; if (item.subC) bg = '#3498db'; if (item.apprC) bg = '#27ae60';
            ctx.fillStyle = bg; ctx.fillRect(x, y, DRAW_CFG.towerWidth, DRAW_CFG.floorHeight);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 1; ctx.strokeRect(x, y, DRAW_CFG.towerWidth, DRAW_CFG.floorHeight);
            ctx.fillStyle = '#1d1d1f'; ctx.textAlign = 'right'; ctx.font = '600 11px -apple-system'; ctx.fillText(f + "F", x - 5, y + 16);
            const textColor = (bg === '#fff') ? '#86868b' : '#fff';
            if (item.plan) { ctx.fillStyle = textColor; ctx.textAlign = 'left'; ctx.font = '11px -apple-system'; ctx.fillText(item.plan, x + 8, y + 16); }
            let finishDate = item.apprC ? item.apprD : (item.subC ? item.subD : "");
            if (finishDate) { ctx.fillStyle = textColor; ctx.textAlign = 'right'; ctx.font = 'bold 11px -apple-system'; ctx.fillText(finishDate, x + DRAW_CFG.towerWidth - 8, y + 16); }
            let durationText = ""; let durationColor = "#86868b";
            if (!item.apprC) {
                if (!item.subC) { const diff = getDaysDiff(item.plan); if (diff !== null) { if (diff > 0) { durationText = `å»¶æœŸ ${diff} å¤©`; durationColor = "#ff3b30"; } else { durationText = `å‰©ä½™ ${Math.abs(diff)} å¤©`; durationColor = "#34c759"; } } }
                else { const diff = getDaysDiff(item.subD); if (diff !== null && diff >= 0) { durationText = `ç­‰å¾… ${diff} å¤©`; durationColor = "#ff9f0a"; } }
            }
            if (durationText) { ctx.fillStyle = durationColor; ctx.textAlign = 'left'; ctx.font = '11px -apple-system'; ctx.fillText(durationText, x + DRAW_CFG.towerWidth + 10, y + 16); }
        });
        ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 2; ctx.strokeRect(x, bottomY - COMMON_CFG.floors.length * DRAW_CFG.floorHeight, DRAW_CFG.towerWidth, COMMON_CFG.floors.length * DRAW_CFG.floorHeight);
    }

    function drawDeliveryBuilding(towerName, x) {
        const bottomY = canvas.height - DRAW_CFG.paddingBottom; const data = GLOBAL_DATA.delivery[towerName];
        const C = { planA: '#ffb7b2', planB: '#a3e4d7', prodA: '#ff7f50', prodB: '#1abc9c', shipA: '#2ecc71', shipB: '#27ae60' };
        ctx.fillStyle = '#1d1d1f'; ctx.font = 'bold 20px -apple-system'; ctx.textAlign = 'center'; ctx.fillText(towerName + " Tower", x + DRAW_CFG.towerWidth/2, DRAW_CFG.paddingTop - 40);
        ctx.font = '12px -apple-system'; ctx.fillStyle = '#86868b'; ctx.textAlign = 'left'; ctx.fillText("æœŸé—´ (å¤©)", x + DRAW_CFG.towerWidth + 10, DRAW_CFG.paddingTop - 10);
        COMMON_CFG.floors.forEach((f, idx) => {
            const y = bottomY - (idx + 1) * DRAW_CFG.floorHeight; const item = data[f];
            let colorA = C.planA, colorB = C.planB;
            if (item.shipC) { colorA = C.shipA; colorB = C.shipB; } else if (item.prodC) { colorA = C.prodA; colorB = C.prodB; }
            if (item.total > 0) {
                const widthA = (item.typeA / item.total) * DRAW_CFG.towerWidth; const widthB = DRAW_CFG.towerWidth - widthA;
                ctx.fillStyle = colorA; ctx.fillRect(x, y, widthA, DRAW_CFG.floorHeight);
                ctx.fillStyle = colorB; ctx.fillRect(x + widthA, y, widthB, DRAW_CFG.floorHeight);
            } else { ctx.fillStyle = '#fff'; ctx.fillRect(x, y, DRAW_CFG.towerWidth, DRAW_CFG.floorHeight); }
            ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 1; ctx.strokeRect(x, y, DRAW_CFG.towerWidth, DRAW_CFG.floorHeight);
            ctx.fillStyle = '#1d1d1f'; ctx.textAlign = 'right'; ctx.font = '600 11px -apple-system'; ctx.fillText(f + "F", x - 5, y + 16);
            if (item.etd) { ctx.fillStyle = '#34495e'; ctx.textAlign = 'left'; ctx.font = '11px -apple-system'; ctx.fillText(item.etd, x + 8, y + 16); }
            let dateText = item.shipD; let isShipped = item.shipC; if (isShipped && item.realShipD) { dateText = "âœ” " + item.realShipD; }
            if (dateText) { ctx.fillStyle = '#34495e'; ctx.textAlign = 'right'; ctx.font = 'bold 11px -apple-system'; ctx.fillText(dateText, x + DRAW_CFG.towerWidth - 8, y + 16); }
            let durationText = ""; let durationColor = "#86868b";
            if (item.etd) {
                if (isShipped && item.realShipD) { const diff = getDaysBetween(item.etd, item.realShipD); if (diff !== null) { if (diff > 0) { durationText = `å»¶æœŸ ${diff} å¤©`; durationColor = "#ff3b30"; } else { durationText = `å®Œæˆ (æå‰ ${Math.abs(diff)})`; durationColor = "#34c759"; } } }
                else if (item.shipD) { const diff = getDaysBetween(item.etd, item.shipD); if (diff !== null) { if (diff > 0) { durationText = `æ’æœŸå»¶å ${diff} å¤©`; durationColor = "#ff9f0a"; } else { durationText = diff === 0 ? "è®¡åˆ’å‡†æ—¶" : `è®¡åˆ’æå‰ ${Math.abs(diff)}`; durationColor = "#34c759"; } } }
            }
            if (durationText) { ctx.fillStyle = durationColor; ctx.textAlign = 'left'; ctx.font = '11px -apple-system'; ctx.fillText(durationText, x + DRAW_CFG.towerWidth + 10, y + 16); }
        });
        ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 2; ctx.strokeRect(x, bottomY - COMMON_CFG.floors.length * DRAW_CFG.floorHeight, DRAW_CFG.towerWidth, COMMON_CFG.floors.length * DRAW_CFG.floorHeight);
    }

    function drawDrawingLegend() {
        const cy = 40; const cx = canvas.width / 2; ctx.textAlign = 'center'; ctx.font = '12px -apple-system';
        ctx.fillStyle = '#3498db'; ctx.fillRect(cx - 100, cy, 15, 15); ctx.fillStyle = '#333'; ctx.fillText("å·²æäº¤", cx - 60, cy + 12);
        ctx.fillStyle = '#27ae60'; ctx.fillRect(cx + 20, cy, 15, 15); ctx.fillStyle = '#333'; ctx.fillText("å·²æ‰¹å¤ (å®Œæˆ)", cx + 80, cy + 12);
    }
    function drawDeliveryLegend() {
        const cy = 40; const cx = canvas.width / 2; ctx.textAlign = 'center'; ctx.font = '12px -apple-system';
        ctx.fillStyle = '#ffb7b2'; ctx.fillRect(cx - 160, cy, 12, 12); ctx.fillStyle = '#a3e4d7'; ctx.fillRect(cx - 148, cy, 12, 12); ctx.fillStyle = '#555'; ctx.fillText("è®¡åˆ’ä¸­", cx - 120, cy + 10);
        ctx.fillStyle = '#ff7f50'; ctx.fillRect(cx - 60, cy, 12, 12); ctx.fillStyle = '#1abc9c'; ctx.fillRect(cx - 48, cy, 12, 12); ctx.fillStyle = '#555'; ctx.fillText("å·²æ’äº§", cx - 20, cy + 10);
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(cx + 40, cy, 12, 12); ctx.fillStyle = '#27ae60'; ctx.fillRect(cx + 52, cy, 12, 12); ctx.fillStyle = '#555'; ctx.fillText("å·²å‘è´§", cx + 80, cy + 10);
    }

    function getDaysBetween(strA, strB) { const dA = new Date(strA); const dB = new Date(strB); if (isNaN(dA) || isNaN(dB)) return null; return Math.ceil((dB - dA) / (1000 * 60 * 60 * 24)); }
    function getDaysDiff(strA) { const today = new Date(); today.setHours(0,0,0,0); const target = new Date(strA); if (isNaN(target)) return null; return Math.ceil((today - target) / (1000 * 60 * 60 * 24)); }

    // ================= 7. Excel Import/Export =================
    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        let moduleName = "";
        if (CTX.module === 'order') {
            moduleName = CONFIG_ORDER.title;
            const wsData = [['æ¥¼å±‚', ...CONFIG_ORDER.cols.flatMap(c=>[c.name+'-çŠ¶æ€', c.name+'-å¤‡æ³¨'])]];
            COMMON_CFG.floors.forEach(f => { const r = [f]; CONFIG_ORDER.cols.forEach(c => { r.push(GLOBAL_DATA.order[f][c.key].c ? "1":""); r.push(GLOBAL_DATA.order[f][c.key].t); }); wsData.push(r); });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "ä¸‹å•è¿›åº¦");
        } else if (CTX.module === 'drawing') {
            moduleName = CONFIG_DRAWING.title;
            const legend = [["è¯´æ˜"], ["è®¡åˆ’æäº¤", "ä¸å¯ç¼–è¾‘"], ["...","..."],[]];
            const header = ['æ¥¼æ ‹','æ¥¼å±‚','è®¡åˆ’æäº¤æ—¶é—´','æäº¤çŠ¶æ€','æäº¤æ—¥æœŸ','æ‰¹å¤çŠ¶æ€','æ‰¹å¤æ—¥æœŸ'];
            let rows = []; ['T4', 'T5'].forEach(t => COMMON_CFG.floors.forEach(f => { const i = GLOBAL_DATA.drawing[t][f]; rows.push([t,f,i.plan,i.subC?"1":"",i.subD,i.apprC?"1":"",i.apprD]); }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([...legend, header, ...rows]), "åŠ å·¥å›¾");
        } else if (CTX.module === 'delivery') {
            moduleName = CONFIG_DELIVERY.title;
            const legend = [["æ•°æ®è¯´æ˜"], ["ETD","é¢„è®¡ç¦»æ¸¯"], ["A/Bç±»å‹","ä¸å¯ç¼–è¾‘"],[]];
            const header = ['æ¥¼æ ‹','æ¥¼å±‚','æ€»æ•°é‡','Aç±»å‹','Bç±»å‹','ETD','å·²æ’äº§','è®¡åˆ’å‘è´§','å·²å‘è´§','å‘è´§æ—¥æœŸ'];
            let rows = []; ['T4', 'T5'].forEach(t => COMMON_CFG.floors.forEach(f => { const i = GLOBAL_DATA.delivery[t][f]; rows.push([t,f,i.total,i.typeA,i.typeB,i.etd,i.prodC?"1":"",i.shipD,i.shipC?"1":"",i.realShipD]); }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([...legend, header, ...rows]), "äº¤ä»˜è®¡åˆ’");
        } else {
            moduleName = CONFIG_NCR.title;
            const legend = [["æ•°æ®è¯´æ˜"], ["NCR No.","å”¯ä¸€ç¼–å·"], ["çŠ¶æ€","1=å·²è§£å†³, 0=æœªè§£å†³"], []];
            const header = [...CONFIG_NCR.cols, "å½“å‰çŠ¶æ€ (Resolved)"];
            let rows = []; GLOBAL_DATA.ncr.forEach(r => rows.push([r.date, r.no, r.mat, r.desc, r.code, r.qty, r.party, r.solved?"1":"0"]));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([...legend, header, ...rows]), "NCRè®°å½•");
        }
        const fileName = `BPO_${moduleName}_${getBeijingTimeStr()}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    function handleFileImport(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
            
            if (CTX.module === 'ncr') {
                let hIdx = -1;
                const map = { d:-1, n:-1, m:-1, ds:-1, c:-1, q:-1, p:-1, s:-1 };
                data.forEach((row, i) => {
                    const str = row.join(" ");
                    if (str.includes("NCR") && str.includes("æŠ¥å‘Šæ—¥æœŸ")) {
                        hIdx = i; row.forEach((c,ci)=>{ const txt=String(c); if(txt.includes("æŠ¥å‘Šæ—¥æœŸ")) map.d=ci; if(txt.includes("NCR")) map.n=ci; if(txt.includes("ææ–™ç±»å‹")) map.m=ci; if(txt.includes("æè¿°")) map.ds=ci; if(txt.includes("Code")) map.c=ci; if(txt.includes("æ•°é‡")) map.q=ci; if(txt.includes("è´£ä»»æ–¹")) map.p=ci; if(txt.includes("çŠ¶æ€")) map.s=ci; });
                    }
                });
                if(hIdx===-1) return alert("æœªæ‰¾åˆ°NCRè¡¨å¤´");
                if(confirm("å¯¼å…¥å°†è¦†ç›–ç°æœ‰NCRåˆ—è¡¨ï¼Œç¡®è®¤å—ï¼Ÿ")) {
                    GLOBAL_DATA.ncr = [];
                    for(let i=hIdx+1; i<data.length; i++){
                        const r = data[i]; if(!r[map.n]) continue; 
                        GLOBAL_DATA.ncr.push({ date: r[map.d]||"", no: r[map.n]||"", mat: r[map.m]||"", desc: r[map.ds]||"", code: r[map.c]||"", qty: r[map.q]||"", party: r[map.p]||"", solved: (map.s !== -1 && (r[map.s] == 1 || r[map.s] == "1")) });
                    }
                    initTable(); alert("NCRå¯¼å…¥æˆåŠŸ");
                }
            } else if (CTX.module === 'delivery') {
                let hIdx = -1;
                const map = {t:-1,f:-1,a:-1,b:-1,etd:-1,prod:-1,ship:-1,realC:-1,realD:-1};
                data.forEach((row, i) => {
                    const s = row.join(" ");
                    if (s.includes("æ¥¼æ ‹") && s.includes("ETD")) {
                        hIdx = i; row.forEach((c,ci)=>{ const txt=String(c); if(txt.includes("æ¥¼æ ‹")) map.t=ci; if(txt.includes("æ¥¼å±‚")) map.f=ci; if(txt.includes("Aç±»å‹")) map.a=ci; if(txt.includes("Bç±»å‹")) map.b=ci; if(txt.includes("ETD")) map.etd=ci; if(txt.includes("å·²æ’äº§")) map.prod=ci; if(txt.includes("è®¡åˆ’å‘è´§")) map.ship=ci; if(txt.includes("å·²å‘è´§")) map.realC=ci; if(txt.includes("å‘è´§æ—¥æœŸ")) map.realD=ci; });
                    }
                });
                if(hIdx===-1) return alert("æ ¼å¼é”™è¯¯");
                for(let i=hIdx+1; i<data.length; i++){
                    const r=data[i]; const t=r[map.t]; const f=parseInt(r[map.f]);
                    if(GLOBAL_DATA.delivery[t] && GLOBAL_DATA.delivery[t][f]){
                        const item = GLOBAL_DATA.delivery[t][f]; if(map.a!==-1 && r[map.a]) item.typeA=parseInt(r[map.a]); if(map.b!==-1 && r[map.b]) item.typeB=parseInt(r[map.b]); item.total = item.typeA + item.typeB; if(map.etd!==-1 && r[map.etd]) item.etd=r[map.etd]; if(map.prod!==-1) item.prodC=(r[map.prod]==1); if(map.ship!==-1) item.shipD=r[map.ship]||""; if(map.realC!==-1) item.shipC=(r[map.realC]==1); if(map.realD!==-1) item.realShipD=r[map.realD]||"";
                    }
                }
                initTable(); drawAll(); alert("å¯¼å…¥æˆåŠŸ");
            } else { alert("è¯·å¯¼å…¥å¯¹åº”æ¨¡å—Excel"); }
            input.value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    function saveAsNewHtml() {
        let htmlContent = document.documentElement.outerHTML;
        let dataJson = JSON.stringify(GLOBAL_DATA);
        htmlContent = htmlContent.replace(/const savedSnapshot = .*?;/, `const savedSnapshot = ${dataJson};`);
        const blob = new Blob([htmlContent], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `è²å¾‹å®¾BPOä»ªè¡¨ç›˜_V22_${new Date().toISOString().slice(0,10)}.html`;
        link.click();
    }

    window.onload = function() {
        updateWatermark("DASHBOARD HOME");
        renderDashboardStats();
    };
</script>
</body>
</html>